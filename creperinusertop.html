<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        $().ready(function () {
            init();
        });

        function init() {
            var username = sessionStorage.getItem('username');
            document.getElementById('welcome').innerHTML = 'ようこそ' + username + 'さん';
            document.getElementById('rank').innerHTML = username + 'さんのランクは' + rank + 'です';
            // document.getElementById("createroomchat").style.display = "none";
        }

        var ctn = 0;
        var rank = localStorage.getItem('rank');      //creperinregisterにrank1をsessionStorageに保存されている。それの呼び出し。
        var username = sessionStorage.getItem('username');
        var contents;


        function tweet() {

            if (document.getElementById('content').value == "") {
                document.getElementById('chat').innerHTML = '何か書いてください';
            }
            else {
                $(document).ready(function () {
                    execSelect();
                });
                async function execSelect() {
                    var content = document.getElementById('content').value;
                    var sql = `insert into Chat (username,rank,tweet,time) values( "${username}","${rank}","${content}",now());`;
                    var objects = osql.connect(sql);
                    console.log(objects);

                    var sql = `SELECT * FROM Chat order by time desc limit 10; `;
                    var objects = await osql.connect(sql);
                    console.log(objects);
                    var html = '';
                    html = html + '<table border="1">';
                    html = html + '<tr>';
                    html = html + '<th>' + 'ユーザー名' + '</th>';
                    html = html + '<th>' + 'ランク' + '</th>';
                    html = html + '<th>' + 'ツイート' + '</th>';
                    html = html + '<th>' + '時間' + '</th>';
                    html = html + '</tr>';
                    for (var i = 0; i < objects.length; i++) {
                        html = html + '<tr>';
                        var object = objects[i];
                        html = html + '<td>' + object.username + '</td>';
                        html = html + '<td>' + object.rank + '</td>';
                        html = html + '<td>' + object.tweet + '</td>';
                        html = html + '<td>' + object.time + '</td>';
                        html = html + '</tr>';
                    }
                    html = html + '</table>';
                    document.getElementById('chat').innerHTML = html;


                }
            }
        }


        //Room作成の処理
        function roomcreate() {
            contents = document.getElementById('roomchat').value;
            if (document.getElementById('roomchat').value == "") {
                document.getElementById('chat2').innerHTML = '何か書いてください';
            }
            else {
                $(document).ready(function () {
                    execSelect();
                });
                async function execSelect() {
                    // var content = document.getElementById('roomchat').value;
                    // var sql = `create table ${contents} (id serial,roomname varchar(20),creater varchar(20) ,tweet varchar(50),time datetime,rank varchar(5)); `;
                    // var objects = osql.connect(sql);
                    // console.log(objects);
                    var sql = `insert into Rooms (roomname,creater) values( "${contents}","${username}");`;
                    var objects = osql.connect(sql);
                    console.log(objects);
                    var sql = `SELECT roomname,creater FROM Rooms; `;
                    var objects = await osql.connect(sql);
                    console.log(objects);
                    var html = '';
                    html = html + '<table border="1">';
                    html = html + '<tr>';
                    html = html + '<th>' + 'ルーム名' + '</th>';
                    // html = html + '<th>' + '人数' + '</th>';
                    html = html + '<th>' + '作成者' + '</th>';
                    // html = html + '<th>' + '参加' + '</th>';
                    html = html + '</tr>';
                    for (var i = 0; i < objects.length; i++) {
                        html = html + '<tr>';
                        var object = objects[i];
                        html = html + '<td>' + '<button onclick="join()">' + object.roomname + '</button >' + '</td>';
                        // html = html + '<td>' + 1 + '</td>';
                        html = html + '<td>' + object.creater + '</td>';
                        // html = html + '<td>' + '<button onclick="join()">参加</button>' + '</td>';
                        html = html + '</tr>';
                    }
                    html = html + '</table>';
                    document.getElementById('chat2').innerHTML = html;
                }
            }
        }


        function join() {       //ルーム作成後参加押したらルーム用のチャットが出てくる処理
            document.getElementById("createroomchat").style.display = "block";
            $(document).ready(function () {
                execSelect();
            });
            async function execSelect() {
                // var sql = `create table ${contents} (id serial,roomname varchar(20),creater varchar(20) ,tweet varchar(50),time datetime,rank varchar(5)); `;
                // var objects = await osql.connect(sql);
                // console.log(objects);
                var sql = `SELECT * FROM Roomchat; `;
                var objects = await osql.connect(sql);
                console.log(objects);
                var html = '';
                html = html + '<table border="1">';
                html = html + '<tr>';
                html = html + '<th>' + 'ユーザー名' + '</th>';
                html = html + '<th>' + 'ランク' + '</th>';
                html = html + '<th>' + 'ツイート' + '</th>';
                // html = html + '<th>' + '時間' + '</th>';
                html = html + '</tr>';
                for (var i = 0; i < objects.length; i++) {
                    html = html + '<tr>';
                    var object = objects[i];
                    html = html + '<td>' + object.username + '</td>';
                    html = html + '<td>' + object.rank + '</td>';
                    html = html + '<td>' + object.tweet + '</td>';
                    // html = html + '<td>' + object.time + '</td>';
                    html = html + '</tr>';
                }
                html = html + '</table>';
                document.getElementById('chat4').innerHTML = html;
            }
        }

        function roomtweet() {        //つぶやきの処理
            $(document).ready(function () {
                execSelect();
            });
            async function execSelect() {
                var content = document.getElementById('roomchatcontent').value;
                var sql = `insert into Roomchat (username,rank,tweet,time,roomname) values( "${username}","${rank}","${content}",now(),"${contents}");`;
                var objects = osql.connect(sql);
                console.log(objects);

                var sql = `SELECT * FROM Roomchat; `;
                var objects = await osql.connect(sql);
                console.log(objects);
                var html = '';
                html = html + '<table border="1">';
                html = html + '<tr>';
                html = html + '<th>' + 'ユーザー名' + '</th>';
                html = html + '<th>' + 'ランク' + '</th>';
                html = html + '<th>' + 'ツイート' + '</th>';
                // html = html + '<th>' + '時間' + '</th>';
                html = html + '</tr>';
                for (var i = 0; i < objects.length; i++) {
                    html = html + '<tr>';
                    var object = objects[i];
                    html = html + '<td>' + object.username + '</td>';
                    html = html + '<td>' + object.rank + '</td>';
                    html = html + '<td>' + object.tweet + '</td>';
                    // html = html + '<td>' + object.time + '</td>';
                    html = html + '</tr>';
                }
                html = html + '</table>';
                document.getElementById('chat4').innerHTML = html;
            }
        }



        var visit = localStorage.getItem('visit');      //creperinregisterにvisitをsessionStorageに保存されている。それの呼び出し。
        console.log(visit);
        var badgescore = localStorage.getItem('badgescore');        //スコアによってバッジの色変
        var rank = localStorage.getItem('rank');    //rankによってバッジの色変
        var answerrate = localStorage.getItem('answerrate');


        window.onload = async function () {     //トップページ読み込み時処理
            var sql = `SELECT * FROM Chat order by time desc limit 10; `;
            var objects = await osql.connect(sql);
            // console.log(objects);
            var html = '';
            html = html + '<table border="1">';
            html = html + '<tr>';
            html = html + '<th>' + 'ユーザー名' + '</th>';
            html = html + '<th>' + 'ランク' + '</th>';
            html = html + '<th>' + 'ツイート' + '</th>';
            html = html + '<th>' + '時間' + '</th>';
            html = html + '</tr>';
            for (var i = 0; i < objects.length; i++) {
                html = html + '<tr>';
                var object = objects[i];
                html = html + '<td>' + object.username + '</td>';
                html = html + '<td>' + object.rank + '</td>';
                html = html + '<td>' + object.tweet + '</td>';
                html = html + '<td>' + object.time + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('chat').innerHTML = html;



            // ルームチャットの処理

            // var sql = `SELECT * FROM Rooms; `;
            // var objects = await osql.connect(sql);
            // // console.log();
            // var html = '';
            // html = html + '<table border="1">';
            // html = html + '<tr>';
            // html = html + '<th>' + 'ルーム名' + '</th>';
            // // html = html + '<th>' + '人数' + '</th>';
            // html = html + '<th>' + '作成者' + '</th>';
            // // html = html + '<th>' + '参加' + '</th>';
            // html = html + '</tr>';
            // for (var i = 0; i < objects.length; i++) {
            //     html = html + '<tr>';
            //     var object = objects[i];
            //     html = html + '<td>' + '<button onclick="join()">' + object.roomname + '</button >' + '</td>';
            //     // html = html + '<td>' + 1 + '</td>';
            //     html = html + '<td>' + object.creater + '</td>';
            //     // html = html + '<td>' + '<button onclick="join()">参加</button>' + '</td>';
            //     html = html + '</tr>';
            // }
            // html = html + '</table>';
            // document.getElementById('chat2').innerHTML = html;





            //バッジの処理

            if (visit >= 5) {
                document.getElementById("btn1").removeAttribute("disabled");    //ボタン押せるようにする
                document.getElementById('btn1').click();        //上のif条件達成時に下に書いたボタンを押す
            }
            if (visit >= 10) {
                document.getElementById("btn2").removeAttribute("disabled");
                document.getElementById('btn2').click();
            }
            if (visit >= 20) {
                document.getElementById("btn3").removeAttribute("disabled");
                document.getElementById('btn3').click();
            }


            if (visit >= 4) {        //1回15分だから4回で1時間。
                document.getElementById("btn4").removeAttribute("disabled");
                document.getElementById('btn4').click();
            }
            if (visit >= 12) {
                document.getElementById("btn5").removeAttribute("disabled");
                document.getElementById('btn5').click();
            }
            if (visit >= 20) {
                document.getElementById("btn6").removeAttribute("disabled");
                document.getElementById('btn6').click();
            }
            if (visit >= 40) {
                document.getElementById("btn7").removeAttribute("disabled");
                document.getElementById('btn7').click();
            }

            if (badgescore >= 600) {          //スコア600いったら
                document.getElementById("btn8").removeAttribute("disabled");
                document.getElementById('btn8').click();
            }
            if (badgescore >= 750) {
                document.getElementById("btn9").removeAttribute("disabled");
                document.getElementById('btn9').click();
            }
            if (badgescore >= 800) {
                document.getElementById("btn10").removeAttribute("disabled");
                document.getElementById('btn10').click();
            }

            if (rank >= 5) {       //ランク5いったら
                document.getElementById("btn11").removeAttribute("disabled");
                document.getElementById('btn11').click();
            }
            if (rank >= 10) {
                document.getElementById("btn12").removeAttribute("disabled");
                document.getElementById('btn12').click();
            }
            if (rank >= 20) {
                document.getElementById("btn13").removeAttribute("disabled");
                document.getElementById('btn13').click();
            }

            if (answerrate >= 90) {         //正答率
                document.getElementById("btn14").removeAttribute("disabled");
                document.getElementById('btn14').click();
            }
            if (answerrate >= 95) {
                document.getElementById("btn15").removeAttribute("disabled");
                document.getElementById('btn15').click();
            }
            if (answerrate >= 100) {
                document.getElementById("btn16").removeAttribute("disabled");
                document.getElementById('btn16').click();
            }
        }




        document.addEventListener("DOMContentLoaded", function () {     //以下はボタンを押したら色変える
            document.getElementById("btn1").setAttribute("disabled", true);     //ボタン押せないようにする
            document.getElementById('btn1').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn2").setAttribute("disabled", true);
            document.getElementById('btn2').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn3").setAttribute("disabled", true);
            document.getElementById('btn3').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";

                }
            )
            document.getElementById("btn4").setAttribute("disabled", true);
            document.getElementById('btn4').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";

                }
            )
            document.getElementById("btn5").setAttribute("disabled", true);
            document.getElementById('btn5').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn6").setAttribute("disabled", true);
            document.getElementById('btn6').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn7").setAttribute("disabled", true);
            document.getElementById('btn7').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn8").setAttribute("disabled", true);
            document.getElementById('btn8').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn9").setAttribute("disabled", true);
            document.getElementById('btn9').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn10").setAttribute("disabled", true);
            document.getElementById('btn10').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn11").setAttribute("disabled", true);
            document.getElementById('btn11').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn12").setAttribute("disabled", true);
            document.getElementById('btn12').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn13").setAttribute("disabled", true);
            document.getElementById('btn13').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn14").setAttribute("disabled", true);
            document.getElementById('btn14').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn15").setAttribute("disabled", true);
            document.getElementById('btn15').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            document.getElementById("btn16").setAttribute("disabled", true);
            document.getElementById('btn16').addEventListener('click',
                function () {
                    this.style.backgroundColor = "red";
                }
            )
            // console.log(ctn);
        })


        var rankdisp = localStorage.getItem('rankdisp');
        var badgedisp = localStorage.getItem('badgedisp');
        var chatdisp = localStorage.getItem('chatdisp');
        var rankingdisp = localStorage.getItem('rankingdisp');
        var rankcount = localStorage.getItem('rankcount');
        var badgecount = localStorage.getItem('badgecount');
        var chatcount = localStorage.getItem('chatcount');
        var rankingcount = localStorage.getItem('rankingcount');



        document.addEventListener("DOMContentLoaded", function () {     //読み込み時機能を表示非表示処理。
            var rankbutton = document.getElementById("rankbutton");
            var badgebutton = document.getElementById("badgebutton");
            var chatbutton = document.getElementById("chatbutton");
            var rankingbutton = document.getElementById("rankingbutton");

            if (rankdisp == 0) {
                document.getElementById("disp1").style.display = "block";
            }
            else {
                document.getElementById("disp1").style.display = "none";
            }

            if (badgedisp == 0) {
                document.getElementById("disp2").style.display = "block";
            }
            else {
                document.getElementById("disp2").style.display = "none";
            }
            if (chatdisp == 0) {
                document.getElementById("disp3").style.display = "block";
            }
            else {
                document.getElementById("disp3").style.display = "none";
            }



            rankbutton.addEventListener("click", function () {      //ランクボタン押した時の処理

                rankcount = Number(rankcount) + 1;      //rankボタン押した回数。(もともと非表示状態。1回押すと表示になる。)
                localStorage.rankcount = rankcount;
                console.log(rankcount);

                if (rankdisp == 0) {        //現在表示中なら
                    rankdisp = 1;　　　　　　//非表示中マーク
                    localStorage.rankdisp = rankdisp;
                    document.getElementById("disp1").style.display = "none";　　　//非表示にする
                }
                else {      //それ以外（現在非表示中なら）
                    rankdisp = 0;       //表示マーク
                    localStorage.rankdisp = rankdisp;
                    document.getElementById("disp1").style.display = "block";　　//表示にする
                }
            }, false);


            badgebutton.addEventListener("click", function () {     //バッジボタン押した時の処理

                badgecount = Number(badgecount) + 1;      //badgeボタン押した回数
                localStorage.badgecount = badgecount;
                console.log(badgecount);

                if (badgedisp == 0) {
                    badgedisp = 1;
                    localStorage.badgedisp = badgedisp;
                    document.getElementById("disp2").style.display = "none";
                }
                else {
                    badgedisp = 0;
                    localStorage.badgedisp = badgedisp;
                    document.getElementById("disp2").style.display = "block";
                }
            }, false);

            chatbutton.addEventListener("click", function () {      //チャットボタン押した時の処理

                chatcount = Number(chatcount) + 1;      //chatボタン押した回数
                localStorage.chatcount = chatcount;
                console.log(chatcount);

                if (chatdisp == 0) {
                    chatdisp = 1;
                    localStorage.chatdisp = chatdisp;
                    document.getElementById("disp3").style.display = "none";
                }
                else {
                    chatdisp = 0;
                    localStorage.chatdisp = chatdisp;
                    document.getElementById("disp3").style.display = "block";
                }
            }, false);

            rankingbutton.addEventListener("click", function () {      //ランキングボタン押した時の処理

                rankingcount = Number(rankingcount) + 1;      //rankingボタン押した回数
                localStorage.rankingcount = rankingcount;
                console.log(rankingcount);

                if (rankingdisp == 0) {
                    rankingdisp = 1;
                    localStorage.rankingdisp = rankingdisp;
                    console.log(rankingdisp);
                    // document.getElementById("disp3").style.display = "none";
                }
                else {
                    rankingdisp = 0;
                    localStorage.rankingdisp = rankingdisp;
                    // console.log(rankingdisp);
                    // document.getElementById("disp3").style.display = "block";
                }
            }, false);


        }, false);

    </script>

</head>

<div>
    <h1>トップページ</h1>
    <p id="welcome"></p>
    <a href="creperintest.html">クレペリン検査はこちら</a>
    <br>
    <br>
    <form>
        <input id="rankbutton" type="checkbox" value="">ランク表示・非表示ボタン
        <br>
        <input id="badgebutton" type="checkbox" value="">バッジ表示・非表示ボタン
        <br>
        <input id="chatbutton" type="checkbox" value="">チャット表示・非表示ボタン
        <br>
        <input id="rankingbutton" type="checkbox" value="">ランキング表示・非表示ボタン
    </form>
</div>
<h2>イベント情報</h2>
<p id="eventinfo" style="border: 3px solid #333">11月20日にイベント開催。その日はクレペリン検査は1回15分が5分に時短され、スコアは3倍されます。</p>
<br>
<div class="left" style="float: left;">
    <div id="disp1">
        <h2>ランク</h2>
        <p id="rank"></p>
    </div>

    <div id="disp2">
        <h2>バッジ</h2>
        <button id="btn1" style="width: 90px; height: 90px;">ゲームを5回した</button>
        <button id="btn2" style="width: 90px; height: 90px;">ゲームを10回した</button>
        <button id="btn3" style="width: 90px; height: 90px;">ゲームを20回した</button>
        <button id="btn4" style="width: 90px; height: 90px;">ゲームを1時間した</button>
        <br>
        <button id="btn5" style="width: 90px; height: 90px;">ゲームを3時間した</button>
        <button id="btn6" style="width: 90px; height: 90px;">ゲームを5時間した</button>
        <button id="btn7" style="width: 90px; height: 90px;">ゲームを10時間した</button>
        <button id="btn8" style="width: 90px; height: 90px;">スコア600突破</button>
        <br>
        <button id="btn9" style="width: 90px; height: 90px;">スコア750突破</button>
        <button id="btn10" style="width: 90px; height: 90px;">スコア900突破</button>
        <button id="btn11" style="width: 90px; height: 90px;">ランク5 突破</button>
        <button id="btn12" style="width: 90px; height: 90px;">ランク10突破</button>
        <br>
        <button id="btn13" style="width: 90px; height: 90px;">ランク20突破</button>
        <button id="btn14" style="width: 90px; height: 90px;">正解率90%超えた</button>
        <button id="btn15" style="width: 90px; height: 90px;">正解率95%超えた</button>
        <button id="btn16" style="width: 90px; height: 90px;">正解率100%達成</button>
    </div>
</div>
<p id="badge"></p>
<div class="right">　
    <div id="disp3">
        <div style="float:left; padding-left: 10px;">
            <br><br>
            <h2>オープンチャット</h2>
            <input type="text" id="content">
            <button onclick="tweet()">つぶやく</button>
            <p id="chat"></p>
            <p>※つぶやき時点のランクです</p>
        </div>
        <!-- <div style="float: left; padding: 10px;">
            <h2>ルームチャット</h2>
            Room名を入力してください<br>
            <input type="text" id="roomchat">
            <button onclick="roomcreate()">作成</button>
            <p id="chat2"></p>
        </div>
        <div style="float: left; padding: 50px;" id="createroomchat">
            <h2 id="chat3"></h2>
            <input type="text" id="roomchatcontent">
            <button onclick="roomtweet()">つぶやく</button>
            <p id="chat4" style="width: 550px;"></p>
        </div> -->
    </div>
</div>


</body>

</html>