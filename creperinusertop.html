<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        $().ready(function () {
            init();
        });

        function init() {
            var username = sessionStorage.getItem('username');
            document.getElementById('welcome').innerHTML = 'ようこそ' + username + 'さん';
            document.getElementById('rank').innerHTML = username + 'さんのランクは' + rank + 'です';
        }


        var rank = localStorage.getItem('rank');      //creperinregisterにrank1をsessionStorageに保存されている。それの呼び出し。



        // function a() {//ボタン押したらランクを1あげる
        //     rank = parseInt(rank) + 1;
        //     console.log(rank);
        //     localStorage.rank = rank;
        // }
        // function b() {//ボタン押したらランク0にする
        //     rank = parseInt(rank) * 0 + 1;
        //     localStorage.rank = rank;
        //     console.log(rank);
        // }


        var username = sessionStorage.getItem('username');


        function tweet() {

            if (document.getElementById('content').value == "") {
                document.getElementById('chat').innerHTML = '何か書いてください';
            }
            else {
                $(document).ready(function () {
                    execSelect();
                });
                async function execSelect() {
                    var content = document.getElementById('content').value;
                    var sql = `insert into Chat (username,tweet,time) values( "${username}","${content}",now());`;
                    var objects = osql.connect(sql);
                    console.log(objects);

                    var sql = `SELECT * FROM Chat order by time desc limit 15; `;
                    var objects = await osql.connect(sql);
                    console.log(objects);
                    var html = '';
                    html = html + '<table border="1">';
                    html = html + '<tr>';
                    html = html + '<th>' + 'ユーザー名' + '</th>';
                    html = html + '<th>' + 'ツイート' + '</th>';
                    // html = html + '<th>' + '時間' + '</th>';
                    html = html + '</tr>';
                    for (var i = 0; i < objects.length; i++) {
                        html = html + '<tr>';
                        var object = objects[i];
                        html = html + '<td>' + object.username + '</td>';
                        html = html + '<td>' + object.tweet + '</td>';
                        // html = html + '<td>' + object.time + '</td>';
                        html = html + '</tr>';
                    }
                    html = html + '</table>';
                    document.getElementById('chat').innerHTML = html;


                }
            }
        }


        window.onload = async function () {
            var sql = `SELECT * FROM Chat order by time desc limit 15; `;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            html = html + '<table border="1">';
            html = html + '<tr>';
            html = html + '<th>' + 'ユーザー名' + '</th>';
            html = html + '<th>' + 'ツイート' + '</th>';
            // html = html + '<th>' + '時間' + '</th>';
            html = html + '</tr>';
            for (var i = 0; i < objects.length; i++) {
                html = html + '<tr>';
                var object = objects[i];
                html = html + '<td>' + object.username + '</td>';
                html = html + '<td>' + object.tweet + '</td>';
                // html = html + '<td>' + object.time + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('chat').innerHTML = html;
        }




    </script>

</head>

<h1>トップページ</h1>
<p id="welcome"></p>
<a href="creperintest.html">クレペリン検査はこちら</a>
<br>
<div class="left" style="float: left;">
    <h2>ランク</h2>
    <p id="rank"></p>
    <h2>バッジ</h2>
    <p id="badge"></p>
</div>
<div class="right" style="float: right; padding-right: 100px; padding-left: 100px;">
    <h2>チャット</h2>
    <input type="text" id="content">
    <button onclick="tweet()">つぶやく</button>
    <p id="chat"></p>
</div>

<!-- <button onclick="a()">a</button>
<button onclick="b()">b</button> -->

</body>

</html>